<!DOCTYPE html>
<html>
  <head>
    <title>Gravity</title>
    <meta charset="UTF-8" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      canvas {
        background-color: #ccc;
      }
    </style>
    <!-- <script src="./js/socket.js" defer> -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"
      defer
    ></script>
    <script defer>
      let score = 0
      let baseSpeed = 1
      let timeInterval = 0.2
      let accel = 1
      let sizeAccel = 0.1
      let canvasSize = window.innerHeight

      const mutationFactor = 12

      var bgImg
      var x1 = 0
      var x2

      var scrollSpeed = 2

      const copter = {
        y: window.innerHeight / 2,
        size: {
          x: 100,
          y: 52,
        },
        speed: baseSpeed,
      }

      let climbingTimeout = null

      function keyPressed() {
        // Unset any running climbs
        clearTimeout(climbingTimeout)

        // Smooth out the curve
        iterations = 0

        climbingTimeout = () => {
          console.log('ran')

          copter.y -= 25 / 60
          iterations++

          if (iterations >= 60) return

          setTimeout(climbingTimeout, 33)
        }

        climbingTimeout()

        copter.speed = baseSpeed
      }

      const ws = new WebSocket('ws://localhost:1337')

      window.pressed = false

      const init = () => {}

      ws.onopen = () => {
        console.log('Connected!')

        setInterval(() => {
          console.log('dispatching request')

          // Dispatch request
          ws.send('poll:request')
        }, 66)
      }

      ws.onmessage = event => {
        console.log(`Messaged received`)

        const { data } = event

        if (data === '1') {
          keyPressed()
        }
      }

      ws.onclose = () => {
        window.pressed = false
      }

      ws.onerror = event => {
        console.error('Failed to connected to WS server', event)
      }

      let img

      function preload() {
        img = loadImage('./img/heli.png')
        bg = loadImage('./img/cave.jpg')
      }

      function setup() {
        createCanvas(window.innerWidth, canvasSize)

        x2 = width
      }

      function draw() {
        clear()

        // Loop the background
        image(bg, x1, 0, width, height)
        image(bg, x2, 0, width, height)

        x1 -= scrollSpeed
        x2 -= scrollSpeed

        if (x1 < -width) {
          x1 = width
        }
        if (x2 < -width) {
          x2 = width
        }

        copter.y = copter.y + timeInterval * copter.speed

        copter.speed = copter.speed + accel * timeInterval
        score += 0.05
        // copter.size.y = copter.size.y + sizeAccel
        // copter.size.x = copter.size.x + sizeAccel

        // Set the color
        fill('#03A187')

        // Draw the ceiling

        beginShape()
        vertex(0, 0)
        vertex(window.innerWidth, 0)
        vertex(
          window.innerWidth,
          noise(Date.now() / 10000 + baseSpeed) * (window.innerHeight / 2)
        )
        vertex(0, noise(Date.now() / 10000) * (window.innerHeight / 2))
        endShape(CLOSE)

        // Draw the floor

        beginShape()
        vertex(0, noise(Date.now() / 10000) * ((window.innerHeight * 2) / 2))
        vertex(
          window.innerWidth,
          noise(Date.now() / 10000 + baseSpeed) * ((window.innerHeight * 2) / 2)
        )
        vertex(window.innerWidth, window.innerHeight)
        vertex(0, window.innerHeight)
        endShape(CLOSE)

        if (
          copter.y < copter.size.y / 2 ||
          copter.y + copter.size.y / 2 > canvasSize
        ) {
          // confirm('YEY! Your score is ' + Math.round(score))

          copter.y = window.innerHeight / 2
          // copter.size = 50
          copter.speed = baseSpeed
          score = 0
        } else {
          image(img, canvasSize / 2, copter.y, copter.size.x, copter.size.y)
        }
      }
    </script>
  </head>
</html>

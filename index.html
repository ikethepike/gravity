<!DOCTYPE html>
<html>
  <head>
    <title>Gravity</title>
    <meta charset="UTF-8" />
    <style>
      html,
      body {
        margin: 0;
        padding: 0;
      }
      canvas {
        background-color: #ccc;
      }
    </style>
    <!-- <script src="./js/socket.js" defer> -->
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.9.0/p5.js"
      defer
    ></script>
    <script defer>
      let score = 0
      let baseSpeed = 1
      let timeInterval = 0.2
      let accel = 1
      let sizeAccel = 0.1
      let canvasSize = window.innerHeight

      const copter = {
        y: 25,
        size: {
          x: 50,
          y: 26,
        },
        speed: baseSpeed,
      }

      function keyPressed() {
        copter.y = copter.y - 25
        copter.speed = baseSpeed
      }

      const ws = new WebSocket('ws://localhost:1337')

      window.pressed = false

      const init = () => {}

      ws.onopen = () => {
        console.log('Connected!')

        setInterval(() => {
          console.log('dispatching request')

          // Dispatch request
          ws.send('poll:request')
        }, 100)
      }

      ws.onmessage = event => {
        console.log(`Messaged received`)

        const { data } = event
        if (data=="1") {
            console.log(data)
            keyPressed()
        }
      }

      ws.onclose = () => {
        window.pressed = false
      }

      ws.onerror = event => {
        console.error('Failed to connected to WS server', event)
      }

      let img

      function preload() {
        img = loadImage('./img/heli.png')
      }

      function setup() {
        createCanvas(window.innerWidth, canvasSize)
      }

      function polygon(x, y, radius, npoints) {
        let angle = TWO_PI / npoints
        beginShape()
        for (let a = 0; a < TWO_PI; a += angle) {
          let sx = x + cos(a) * radius
          let sy = y + sin(a) * radius
          vertex(sx, sy)
        }
        endShape(CLOSE)
      }

      function draw() {
        clear()
        copter.y = copter.y + timeInterval * copter.speed

        copter.speed = copter.speed + accel * timeInterval
        score += 0.05
        // copter.size.y = copter.size.y + sizeAccel
        // copter.size.x = copter.size.x + sizeAccel

        beginShape()
        vertex(0, 0)
        vertex(window.innerWidth, 0)
        vertex(window.innerWidth, noise(Date.now() / 10000) * 300)
        vertex(0, noise(Date.now() / 10000) * 400)
        endShape(CLOSE)

        if (
          copter.y < copter.size.y / 2 ||
          copter.y + copter.size.y / 2 > canvasSize
        ) {
          confirm('YEY! Your score is ' + Math.round(score))

          copter.y = 25
          // copter.size = 50
          copter.speed = baseSpeed
          score = 0
        } else {
          image(img, canvasSize / 2, copter.y, copter.size.x, copter.size.y)
          // ellipse(canvasSize / 2, copter.y, copter.size, copter.size)
        }
      }

      document.addEventListener('keyup', keyPressed)
    </script>
  </head>
</html>
